#!/bin/bash

NETWORK=$(nmcli -e no -f ssid,bssid --terse device wifi list | bemenu -i -l 10 -p 'network')
if [ -z "$NETWORK" ]; then
    exit
fi

# nmcli uses `:` as delimiters (no idea why as
# the BSSIDs also use `:` as delimiters...) so here we
# replace the `:` delimiter with `@` instead.
# I'm not sure if ESSIDs can have `:` in them or not
# but this should also handle that case.
NETWORK=$(echo $NETWORK | rev | sed 's/:/@/6' | rev)
ESSID=$(echo $NETWORK | cut -d'@' -f 1)
BSSID=$(echo $NETWORK | cut -d'@' -f 2)

CONF=~/docs/networks/"${NETWORK}"
if [[ ! -f "$CONF" ]]; then
    echo "" | bemenu -l 0 -p "password" > "$CONF"
fi

PASS=$(cat $CONF)
nmcli device wifi connect $BSSID password ${PASS}
notify-send -t 5000 "Connected to ${ESSID}."
