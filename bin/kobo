#!/bin/bash

CMD=$1
KOBOANNO=~/projects/tools/kobo/main.py

function e {
    echo "$1"
    notify-send "$1"
}

if [[ -z $CMD ]]; then
    e "No command specified. Comamnds: [sync]."
    exit 1

elif [ $CMD == 'sync' ]; then
    echo "Mounting Kobo disk..."
    KOBODISK=$(lsblk -ro NAME,LABEL | grep KOBOeReader | cut -d' ' -f1)
    if [[ -z ${KOBODISK} ]]; then
        e "Kobo doesn't seem to be plugged in"
        exit 1
    fi
    sudo mount /dev/${KOBODISK} /media/usb

    echo "Syncing books to Kobo..."
    sudo rsync --delete --exclude=read -ravu ~/docs/library/epubs/kobo /media/usb/books/

    echo "Syncing annotations from Kobo..."
    sudo cp /media/usb/.kobo/KoboReader.sqlite /tmp/KoboReader.sqlite
    python "$KOBOANNO" /tmp/KoboReader.sqlite ~/notes/kobo.json

    echo "Unmounting..."
    sudo umount /media/usb
else
    e "Unrecognized command"
fi