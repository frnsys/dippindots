#!/bin/bash
# for this to work w/o entering a sudo password,
# add the following to /etc/sudoers.d/00_anarres:
#   ftseng  ALL = NOPASSWD: /usr/bin/wg, /usr/bin/wg-quick

VPN_DIR=/home/ftseng/docs/vpn
ACTIVE=$(basename $(readlink $VPN_DIR/active))

if [[ $1 == 'up' ]]; then
    # to set active vpn server, symlink its folder, i.e.:
    # rm ~/docs/vpn/active; ln -s ~/docs/vpn/<name>.conf ~/docs/vpn/active
    if [[ $(sudo wg show | grep active) ]]; then
        sudo wg-quick down active
    fi
    sudo wg-quick up active
    notify-send "VPN active ($ACTIVE)"

elif [[ $1 == 'down' ]]; then
    if [[ $(sudo wg show | grep active) ]]; then
        sudo wg-quick down active
    fi
    notify-send "VPN deactivated"

elif [[ $1 == 'switch' ]]; then
    CHOICE=$(find "$VPN_DIR" -type f -printf '%P\n' | dmenu)
    if [ -z "$CHOICE" ]; then
        exit
    fi
    rm $VPN_DIR/active
    ln -s $VPN_DIR/$CHOICE $VPN_DIR/active
    notify-send "Active VPN is now $CHOICE. Restarting..."
    vpn down
    vpn up

elif [[ $1 == 'best' ]]; then
    BEST=""
    BEST_VPN=""
    notify-send "Pinging servers..."
    for f in $VPN_DIR/*.conf; do
        VPN=$(echo $f | cut -d'/' -f6)
        REMOTE=$(cat $f | grep "Address" | cut -d' ' -f3 | cut -d'/' -f1)
        PING=$(ping -c 1 -W 2 $REMOTE | grep time= | cut -f4 -d'=' | cut -f1 -d' ')
        if [ -z "$PING" ]; then
            echo "$VPN: No response"
        else
            # Round
            PING=$(printf "%.*f\n" 0 $PING)
            echo "$VPN: ${PING}ms"
            if [ -z "$BEST" ] || [ "$PING" -lt "$BEST" ]; then
                BEST=$PING
                BEST_VPN=$VPN
            fi
        fi
    done
    if [ -z "$BEST" ]; then
        echo "No servers could be reached"
        notify-send "No servers could be reached"
    else
        echo "Best: $BEST_VPN (${BEST}ms)"
        notify-send "Best: $BEST_VPN (${BEST}ms)"
    fi

elif [[ $1 == 'which' ]]; then
    notify-send "Active VPN is $ACTIVE"

else
    echo "Please specify one of 'up', 'down', 'switch', 'which', 'best'."
    exit 0
fi