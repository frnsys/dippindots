#!/usr/bin/python3

import os
import json
import webbrowser

path = os.path.expanduser('~/notes/annos/phone.json')
books = json.load(open(path))

style = '''
html {
    overflow-x: hidden;
}
input {
    width: 100%;
    max-width: 720px;
    margin: 1em auto;
    display: block;
}
article {
    margin: 4em auto;
    max-width: 720px;
    line-height: 1.4;
    padding-bottom: 4em;
    border-bottom: 2px solid black;
    font-family: system-ui, sans-serif;
}
h2 {
    position: sticky;
    top: 0;
    background: #fff;
}
.highlight {
    margin: 2em 0;
}
.highlight p:last-of-type {
    margin-bottom: 0;
}
.pages {
    color: #888;
    font-size: 0.8em;
}
a {
    color: blue;
}
img {
    max-width: 100%;
}
'''

html = '''
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>{style}</style>
</head>
<body>
{body}
</body>
</html>
'''

book_htmls = []
for book in books:
    if not book['citations']: continue

    try:
        title = book['data']['doc_title']
        authors = book['data']['doc_authors']
    except:
        print('Missing data:', book['data'])
        continue

    hilis = []
    for cite in book['citations']:
        body = cite['note_body']

        data = json.loads(cite['note_data'])
        start_pg = cite['note_page']
        end_pg = data['pageEnd']
        pages = 'pp{}-{}'.format(start_pg, end_pg) if start_pg != end_pg else 'p{}'.format(start_pg)

        hilis.append((body, pages))

    book_html = '''
    <article>
        <h2>{title}. {authors}.</h2>
        {hilis}
    </article>
    '''.format(
            title=title, authors=authors,
            hilis='\n'.join('''
                <div class="highlight">
                    <p>{0}</p>
                    <div class="pages"><em>{1}</em></div>
                </div>
            '''.format(*hili) for hili in hilis))
    book_htmls.append(book_html)

with open('/tmp/phone_books.html', 'w') as f:
    f.write(
        html.format(
            style=style,
            body='\n'.join(book_htmls)))

webbrowser.open('/tmp/phone_books.html')